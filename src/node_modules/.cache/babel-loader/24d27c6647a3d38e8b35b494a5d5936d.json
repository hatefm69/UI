{"ast":null,"code":"var Stream = require('stream');\n\nvar Response = require('./response');\n\nvar Base64 = require('Base64');\n\nvar inherits = require('inherits');\n\nvar Request = module.exports = function (xhr, params) {\n  var self = this;\n  self.writable = true;\n  self.xhr = xhr;\n  self.body = [];\n  self.uri = (params.protocol || 'http:') + '//' + params.host + (params.port ? ':' + params.port : '') + (params.path || '/');\n\n  if (typeof params.withCredentials === 'undefined') {\n    params.withCredentials = true;\n  }\n\n  try {\n    xhr.withCredentials = params.withCredentials;\n  } catch (e) {}\n\n  if (params.responseType) try {\n    xhr.responseType = params.responseType;\n  } catch (e) {}\n  xhr.open(params.method || 'GET', self.uri, true);\n\n  xhr.onerror = function (event) {\n    self.emit('error', new Error('Network error'));\n  };\n\n  self._headers = {};\n\n  if (params.headers) {\n    var keys = objectKeys(params.headers);\n\n    for (var i = 0; i < keys.length; i++) {\n      var key = keys[i];\n      if (!self.isSafeRequestHeader(key)) continue;\n      var value = params.headers[key];\n      self.setHeader(key, value);\n    }\n  }\n\n  if (params.auth) {\n    //basic auth\n    this.setHeader('Authorization', 'Basic ' + Base64.btoa(params.auth));\n  }\n\n  var res = new Response();\n  res.on('close', function () {\n    self.emit('close');\n  });\n  res.on('ready', function () {\n    self.emit('response', res);\n  });\n  res.on('error', function (err) {\n    self.emit('error', err);\n  });\n\n  xhr.onreadystatechange = function () {\n    // Fix for IE9 bug\n    // SCRIPT575: Could not complete the operation due to error c00c023f\n    // It happens when a request is aborted, calling the success callback anyway with readyState === 4\n    if (xhr.__aborted) return;\n    res.handle(xhr);\n  };\n};\n\ninherits(Request, Stream);\n\nRequest.prototype.setHeader = function (key, value) {\n  this._headers[key.toLowerCase()] = value;\n};\n\nRequest.prototype.getHeader = function (key) {\n  return this._headers[key.toLowerCase()];\n};\n\nRequest.prototype.removeHeader = function (key) {\n  delete this._headers[key.toLowerCase()];\n};\n\nRequest.prototype.write = function (s) {\n  this.body.push(s);\n};\n\nRequest.prototype.destroy = function (s) {\n  this.xhr.__aborted = true;\n  this.xhr.abort();\n  this.emit('close');\n};\n\nRequest.prototype.end = function (s) {\n  if (s !== undefined) this.body.push(s);\n  var keys = objectKeys(this._headers);\n\n  for (var i = 0; i < keys.length; i++) {\n    var key = keys[i];\n    var value = this._headers[key];\n\n    if (isArray(value)) {\n      for (var j = 0; j < value.length; j++) {\n        this.xhr.setRequestHeader(key, value[j]);\n      }\n    } else this.xhr.setRequestHeader(key, value);\n  }\n\n  if (this.body.length === 0) {\n    this.xhr.send('');\n  } else if (typeof this.body[0] === 'string') {\n    this.xhr.send(this.body.join(''));\n  } else if (isArray(this.body[0])) {\n    var body = [];\n\n    for (var i = 0; i < this.body.length; i++) {\n      body.push.apply(body, this.body[i]);\n    }\n\n    this.xhr.send(body);\n  } else if (/Array/.test(Object.prototype.toString.call(this.body[0]))) {\n    var len = 0;\n\n    for (var i = 0; i < this.body.length; i++) {\n      len += this.body[i].length;\n    }\n\n    var body = new this.body[0].constructor(len);\n    var k = 0;\n\n    for (var i = 0; i < this.body.length; i++) {\n      var b = this.body[i];\n\n      for (var j = 0; j < b.length; j++) {\n        body[k++] = b[j];\n      }\n    }\n\n    this.xhr.send(body);\n  } else if (isXHR2Compatible(this.body[0])) {\n    this.xhr.send(this.body[0]);\n  } else {\n    var body = '';\n\n    for (var i = 0; i < this.body.length; i++) {\n      body += this.body[i].toString();\n    }\n\n    this.xhr.send(body);\n  }\n}; // Taken from http://dxr.mozilla.org/mozilla/mozilla-central/content/base/src/nsXMLHttpRequest.cpp.html\n\n\nRequest.unsafeHeaders = [\"accept-charset\", \"accept-encoding\", \"access-control-request-headers\", \"access-control-request-method\", \"connection\", \"content-length\", \"cookie\", \"cookie2\", \"content-transfer-encoding\", \"date\", \"expect\", \"host\", \"keep-alive\", \"origin\", \"referer\", \"te\", \"trailer\", \"transfer-encoding\", \"upgrade\", \"user-agent\", \"via\"];\n\nRequest.prototype.isSafeRequestHeader = function (headerName) {\n  if (!headerName) return false;\n  return indexOf(Request.unsafeHeaders, headerName.toLowerCase()) === -1;\n};\n\nvar objectKeys = Object.keys || function (obj) {\n  var keys = [];\n\n  for (var key in obj) {\n    keys.push(key);\n  }\n\n  return keys;\n};\n\nvar isArray = Array.isArray || function (xs) {\n  return Object.prototype.toString.call(xs) === '[object Array]';\n};\n\nvar indexOf = function indexOf(xs, x) {\n  if (xs.indexOf) return xs.indexOf(x);\n\n  for (var i = 0; i < xs.length; i++) {\n    if (xs[i] === x) return i;\n  }\n\n  return -1;\n};\n\nvar isXHR2Compatible = function isXHR2Compatible(obj) {\n  if (typeof Blob !== 'undefined' && obj instanceof Blob) return true;\n  if (typeof ArrayBuffer !== 'undefined' && obj instanceof ArrayBuffer) return true;\n  if (typeof FormData !== 'undefined' && obj instanceof FormData) return true;\n};","map":null,"metadata":{},"sourceType":"script"}