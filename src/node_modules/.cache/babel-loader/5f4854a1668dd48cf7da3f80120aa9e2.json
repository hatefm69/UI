{"ast":null,"code":"var Stream = require('stream');\n\nvar util = require('util');\n\nvar Response = module.exports = function (res) {\n  this.offset = 0;\n  this.readable = true;\n};\n\nutil.inherits(Response, Stream);\nvar capable = {\n  streaming: true,\n  status2: true\n};\n\nfunction parseHeaders(res) {\n  var lines = res.getAllResponseHeaders().split(/\\r?\\n/);\n  var headers = {};\n\n  for (var i = 0; i < lines.length; i++) {\n    var line = lines[i];\n    if (line === '') continue;\n    var m = line.match(/^([^:]+):\\s*(.*)/);\n\n    if (m) {\n      var key = m[1].toLowerCase(),\n          value = m[2];\n\n      if (headers[key] !== undefined) {\n        if (isArray(headers[key])) {\n          headers[key].push(value);\n        } else {\n          headers[key] = [headers[key], value];\n        }\n      } else {\n        headers[key] = value;\n      }\n    } else {\n      headers[line] = true;\n    }\n  }\n\n  return headers;\n}\n\nResponse.prototype.getResponse = function (xhr) {\n  var respType = String(xhr.responseType).toLowerCase();\n  if (respType === 'blob') return xhr.responseBlob || xhr.response;\n  if (respType === 'arraybuffer') return xhr.response;\n  return xhr.responseText;\n};\n\nResponse.prototype.getHeader = function (key) {\n  return this.headers[key.toLowerCase()];\n};\n\nResponse.prototype.handle = function (res) {\n  if (res.readyState === 2 && capable.status2) {\n    try {\n      this.statusCode = res.status;\n      this.headers = parseHeaders(res);\n    } catch (err) {\n      capable.status2 = false;\n    }\n\n    if (capable.status2) {\n      this.emit('ready');\n    }\n  } else if (capable.streaming && res.readyState === 3) {\n    try {\n      if (!this.statusCode) {\n        this.statusCode = res.status;\n        this.headers = parseHeaders(res);\n        this.emit('ready');\n      }\n    } catch (err) {}\n\n    try {\n      this._emitData(res);\n    } catch (err) {\n      capable.streaming = false;\n    }\n  } else if (res.readyState === 4) {\n    if (!this.statusCode) {\n      this.statusCode = res.status;\n      this.emit('ready');\n    }\n\n    this._emitData(res);\n\n    if (res.error) {\n      this.emit('error', this.getResponse(res));\n    } else this.emit('end');\n\n    this.emit('close');\n  }\n};\n\nResponse.prototype._emitData = function (res) {\n  var respBody = this.getResponse(res);\n\n  if (respBody.toString().match(/ArrayBuffer/)) {\n    this.emit('data', new Uint8Array(respBody, this.offset));\n    this.offset = respBody.byteLength;\n    return;\n  }\n\n  if (respBody.length > this.offset) {\n    this.emit('data', respBody.slice(this.offset));\n    this.offset = respBody.length;\n  }\n};\n\nvar isArray = Array.isArray || function (xs) {\n  return Object.prototype.toString.call(xs) === '[object Array]';\n};","map":null,"metadata":{},"sourceType":"script"}